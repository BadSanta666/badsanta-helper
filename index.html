<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BadSanta's Helper</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const firebaseConfig = {
          apiKey: "AIzaSyBfscDCuTVN6BKNMC_BHdaHn6_RErFmYVY",
          authDomain: "badsanta-helper.firebaseapp.com",
          projectId: "badsanta-helper",
          storageBucket: "badsanta-helper.firebasestorage.app",
          messagingSenderId: "416902560841",
          appId: "1:416902560841:web:71a241fbb540ae46155398"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const { useState, useEffect } = React;
        
        const translations = {
          en: {
            title: "BadSanta's Helper",
            players: "Players",
            squads: "Squads",
            sharedDb: "Shared Database: All players are synced in real-time with everyone!",
            quickSearch: "Quick Search",
            byPlayerId: "By Player ID",
            byAlliance: "By Alliance",
            byState: "By State",
            searchBtn: "Search",
            searchPlayers: "Search players...",
            exportBackup: "Export Backup",
            addPlayer: "Add Player",
            editPlayer: "Edit Player",
            addNewPlayer: "Add New Player",
            playerName: "Player Name",
            playerId: "Player ID",
            noTag: "No Tag",
            suspicious: "Suspicious",
            friendly: "Friendly",
            powerLevel: "Power Level (Optional)",
            alliance: "Alliance",
            state: "State",
            notes: "Notes",
            savePlayer: "Save Player",
            updatePlayer: "Update Player",
            edit: "Edit",
            delete: "Delete",
            confirmDelete: "Confirm Delete",
            deleteQuestion: "Delete this player record?",
            cancel: "Cancel",
            noPlayersFound: "No players found",
            found: "Found",
            recordsForId: "record(s) for ID:",
            nameChanged: "This player changed names",
            times: "times!",
            noPlayerWithId: "No player with ID:",
            inAlliance: "in alliance",
            inState: "in state",
            previousIdentities: "Previous identities:",
            clearAll: "Clear All",
            clearAllQuestion: "Reset all troop amounts, squad sizes, and compositions?",
            totalTroops: "Total Available Troops",
            infantry: "Infantry",
            lancer: "Lancer",
            marksmen: "Marksmen",
            squadSizes: "Squad Sizes",
            addSquad: "Add Squad",
            enterTroopCount: "Enter total troop count per squad",
            squad: "Squad",
            troopCount: "Troop count",
            squadComposition: "Squad Composition (%)",
            savedPresets: "Saved Presets:",
            useAll: "Use all of a specific troop type:",
            useAllInfantry: "Use All Infantry",
            useAllLancer: "Use All Lancer",
            useAllMarksmen: "Use All Marksmen",
            total: "Total",
            saveComposition: "Save current composition:",
            presetName: "Preset name (e.g. 'Defense')",
            save: "Save",
            manualBuilder: "Manual Squad Builder",
            hide: "Hide",
            experimentTroops: "Experiment with troop amounts and see ratios",
            infantryAmount: "Infantry amount",
            lancerAmount: "Lancer amount",
            marksmenAmount: "Marksmen amount",
            resultingRatios: "Resulting Ratios:",
            applyRatios: "Apply These Ratios",
            error: "Error:",
            calculateSquads: "Calculate Squads",
            calculatedSquads: "Calculated Squads",
            clear: "Clear",
            totalUsage: "Total Usage:",
            enterPlayerId: "Enter Player ID...",
            enterAlliance: "Enter Alliance...",
            enterState: "Enter State...",
            id: "ID"
          },
          es: {
            title: "Ayudante de BadSanta",
            players: "Jugadores",
            squads: "Escuadrones",
            sharedDb: "Â¡Base de datos compartida: Todos los jugadores se sincronizan en tiempo real!",
            quickSearch: "BÃºsqueda RÃ¡pida",
            byPlayerId: "Por ID de Jugador",
            byAlliance: "Por Alianza",
            byState: "Por Estado",
            searchBtn: "Buscar",
            searchPlayers: "Buscar jugadores...",
            exportBackup: "Exportar Respaldo",
            addPlayer: "Agregar Jugador",
            editPlayer: "Editar Jugador",
            addNewPlayer: "Agregar Nuevo Jugador",
            playerName: "Nombre del Jugador",
            playerId: "ID del Jugador",
            noTag: "Sin Etiqueta",
            suspicious: "Sospechoso",
            friendly: "Amigable",
            powerLevel: "Nivel de Poder (Opcional)",
            alliance: "Alianza",
            state: "Estado",
            notes: "Notas",
            savePlayer: "Guardar Jugador",
            updatePlayer: "Actualizar Jugador",
            edit: "Editar",
            delete: "Eliminar",
            confirmDelete: "Confirmar EliminaciÃ³n",
            deleteQuestion: "Â¿Eliminar este registro de jugador?",
            cancel: "Cancelar",
            noPlayersFound: "No se encontraron jugadores",
            found: "Encontrado",
            recordsForId: "registro(s) para ID:",
            nameChanged: "Este jugador cambiÃ³ de nombre",
            times: "veces!",
            noPlayerWithId: "NingÃºn jugador con ID:",
            inAlliance: "en alianza",
            inState: "en estado",
            previousIdentities: "Identidades previas:",
            clearAll: "Limpiar Todo",
            clearAllQuestion: "Â¿Restablecer todas las cantidades de tropas, tamaÃ±os de escuadrones y composiciones?",
            totalTroops: "Tropas Disponibles Totales",
            infantry: "InfanterÃ­a",
            lancer: "Lanceros",
            marksmen: "Tiradores",
            squadSizes: "TamaÃ±os de EscuadrÃ³n",
            addSquad: "Agregar EscuadrÃ³n",
            enterTroopCount: "Ingrese el total de tropas por escuadrÃ³n",
            squad: "EscuadrÃ³n",
            troopCount: "Cantidad de tropas",
            squadComposition: "ComposiciÃ³n del EscuadrÃ³n (%)",
            savedPresets: "Preajustes Guardados:",
            useAll: "Usar todas las tropas de un tipo especÃ­fico:",
            useAllInfantry: "Usar Toda InfanterÃ­a",
            useAllLancer: "Usar Todos Lanceros",
            useAllMarksmen: "Usar Todos Tiradores",
            total: "Total",
            saveComposition: "Guardar composiciÃ³n actual:",
            presetName: "Nombre del preajuste (ej. 'Defensa')",
            save: "Guardar",
            manualBuilder: "Constructor Manual de EscuadrÃ³n",
            hide: "Ocultar",
            experimentTroops: "Experimenta con cantidades de tropas y ve las proporciones",
            infantryAmount: "Cantidad de infanterÃ­a",
            lancerAmount: "Cantidad de lanceros",
            marksmenAmount: "Cantidad de tiradores",
            resultingRatios: "Proporciones Resultantes:",
            applyRatios: "Aplicar Estas Proporciones",
            error: "Error:",
            calculateSquads: "Calcular Escuadrones",
            calculatedSquads: "Escuadrones Calculados",
            clear: "Limpiar",
            totalUsage: "Uso Total:",
            enterPlayerId: "Ingresar ID de Jugador...",
            enterAlliance: "Ingresar Alianza...",
            enterState: "Ingresar Estado...",
            id: "ID"
          },
          ar: {
            title: "Ù…Ø³Ø§Ø¹Ø¯ BadSanta",
            players: "Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†",
            squads: "Ø§Ù„ÙØ±Ù‚",
            sharedDb: "Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ØªØ±ÙƒØ©: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…ØªØ²Ø§Ù…Ù†ÙˆÙ† ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ!",
            quickSearch: "Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹",
            byPlayerId: "Ø­Ø³Ø¨ Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨",
            byAlliance: "Ø­Ø³Ø¨ Ø§Ù„ØªØ­Ø§Ù„Ù",
            byState: "Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©",
            searchBtn: "Ø¨Ø­Ø«",
            searchPlayers: "Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...",
            exportBackup: "ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©",
            addPlayer: "Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨",
            editPlayer: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨",
            addNewPlayer: "Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯",
            playerName: "Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨",
            playerId: "Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨",
            noTag: "Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø©",
            suspicious: "Ù…Ø´Ø¨ÙˆÙ‡",
            friendly: "ÙˆØ¯ÙˆØ¯",
            powerLevel: "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
            alliance: "Ø§Ù„ØªØ­Ø§Ù„Ù",
            state: "Ø§Ù„ÙˆÙ„Ø§ÙŠØ©",
            notes: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
            savePlayer: "Ø­ÙØ¸ Ø§Ù„Ù„Ø§Ø¹Ø¨",
            updatePlayer: "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø§Ø¹Ø¨",
            edit: "ØªØ¹Ø¯ÙŠÙ„",
            delete: "Ø­Ø°Ù",
            confirmDelete: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù",
            deleteQuestion: "Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‡Ø°Ø§ØŸ",
            cancel: "Ø¥Ù„ØºØ§Ø¡",
            noPlayersFound: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù„Ø§Ø¹Ø¨ÙŠÙ†",
            found: "ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰",
            recordsForId: "Ø³Ø¬Ù„ (Ø³Ø¬Ù„Ø§Øª) Ù„Ù„Ù…Ø¹Ø±Ù:",
            nameChanged: "ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ø³Ù…Ù‡",
            times: "Ù…Ø±Ø§Øª!",
            noPlayerWithId: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù:",
            inAlliance: "ÙÙŠ Ø§Ù„ØªØ­Ø§Ù„Ù",
            inState: "ÙÙŠ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©",
            previousIdentities: "Ø§Ù„Ù‡ÙˆÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:",
            clearAll: "Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„",
            clearAllQuestion: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù‚ÙˆØ§Øª ÙˆØ£Ø­Ø¬Ø§Ù… Ø§Ù„ÙØ±Ù‚ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ¨Ø§ØªØŸ",
            totalTroops: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙˆØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©",
            infantry: "Ø§Ù„Ù…Ø´Ø§Ø©",
            lancer: "Ø§Ù„Ø±Ù…Ø§Ø­",
            marksmen: "Ø§Ù„Ø±Ù…Ø§Ø©",
            squadSizes: "Ø£Ø­Ø¬Ø§Ù… Ø§Ù„ÙØ±Ù‚",
            addSquad: "Ø¥Ø¶Ø§ÙØ© ÙØ±Ù‚Ø©",
            enterTroopCount: "Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙˆØ§Øª Ù„ÙƒÙ„ ÙØ±Ù‚Ø©",
            squad: "ÙØ±Ù‚Ø©",
            troopCount: "Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙˆØ§Øª",
            squadComposition: "ØªØ±ÙƒÙŠØ¨ Ø§Ù„ÙØ±Ù‚Ø© (%)",
            savedPresets: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:",
            useAll: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Øª Ù†ÙˆØ¹ Ù…Ø¹ÙŠÙ†:",
            useAllInfantry: "Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø©",
            useAllLancer: "Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„ Ø§Ù„Ø±Ù…Ø§Ø­",
            useAllMarksmen: "Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„ Ø§Ù„Ø±Ù…Ø§Ø©",
            total: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",
            saveComposition: "Ø­ÙØ¸ Ø§Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ:",
            presetName: "Ø§Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ (Ù…Ø«Ù„ 'Ø¯ÙØ§Ø¹')",
            save: "Ø­ÙØ¸",
            manualBuilder: "Ù…Ù†Ø´Ø¦ Ø§Ù„ÙØ±Ù‚ Ø§Ù„ÙŠØ¯ÙˆÙŠ",
            hide: "Ø¥Ø®ÙØ§Ø¡",
            experimentTroops: "Ø¬Ø±Ø¨ ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù‚ÙˆØ§Øª ÙˆØ´Ø§Ù‡Ø¯ Ø§Ù„Ù†Ø³Ø¨",
            infantryAmount: "ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´Ø§Ø©",
            lancerAmount: "ÙƒÙ…ÙŠØ© Ø§Ù„Ø±Ù…Ø§Ø­",
            marksmenAmount: "ÙƒÙ…ÙŠØ© Ø§Ù„Ø±Ù…Ø§Ø©",
            resultingRatios: "Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù†Ø§ØªØ¬Ø©:",
            applyRatios: "ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø¨",
            error: "Ø®Ø·Ø£:",
            calculateSquads: "Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚",
            calculatedSquads: "Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©",
            clear: "Ù…Ø³Ø­",
            totalUsage: "Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:",
            enterPlayerId: "Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨...",
            enterAlliance: "Ø£Ø¯Ø®Ù„ Ø§Ù„ØªØ­Ø§Ù„Ù...",
            enterState: "Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©...",
            id: "Ø§Ù„Ù…Ø¹Ø±Ù"
          }
        };
        
        const Search = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
        );
        const Users = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
        );
        const Shield = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        );
        const AlertTriangle = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        );
        const Plus = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        );
        const Trash2 = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        );
        const Edit2 = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
        );
        const X = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        );
        const ChevronDown = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
        );
        const ChevronUp = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
        );
        const ChevronRight = ({size = 24, className = ""}) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
        );

        function GameTracker() {
          const [activeTab, setActiveTab] = useState('players');
          const [players, setPlayers] = useState([]);
          const [expandedStates, setExpandedStates] = useState({});
          const [expandedAlliances, setExpandedAlliances] = useState({});
          const [expandedPlayer, setExpandedPlayer] = useState(null);
          const [searchTerm, setSearchTerm] = useState('');
          const [idSearchTerm, setIdSearchTerm] = useState('');
          const [idSearchResults, setIdSearchResults] = useState([]);
          const [allianceSearchTerm, setAllianceSearchTerm] = useState('');
          const [allianceSearchResults, setAllianceSearchResults] = useState([]);
          const [stateSearchTerm, setStateSearchTerm] = useState('');
          const [stateSearchResults, setStateSearchResults] = useState([]);
          const [language, setLanguage] = useState('en');
          
          const [playerForm, setPlayerForm] = useState({
            name: '', alliance: '', state: '', playerId: '', notes: '', tag: 'none', powerLevel: ''
          });
          
          const [totalTroops, setTotalTroops] = useState({ infantry: '', lancer: '', marksmen: '' });
          const [squadSizes, setSquadSizes] = useState(['']);
          const [squadComposition, setSquadComposition] = useState({ infantry: '10', lancer: '20', marksmen: '70' });
          const [calculatedSquads, setCalculatedSquads] = useState([]);
          const [showPlayerForm, setShowPlayerForm] = useState(false);
          const [editingPlayer, setEditingPlayer] = useState(null);
          const [errorMessage, setErrorMessage] = useState('');
          const [deletingPlayerId, setDeletingPlayerId] = useState(null);
          const [manualSquadMode, setManualSquadMode] = useState(false);
          const [manualSquad, setManualSquad] = useState({ infantry: '', lancer: '', marksmen: '' });
          const [showClearConfirm, setShowClearConfirm] = useState(false);
          const [savedSquadPresets, setSavedSquadPresets] = useState([]);
          const [presetName, setPresetName] = useState('');

          const t = translations[language];
          const isRTL = language === 'ar';

          useEffect(() => {
            const savedLanguage = localStorage.getItem('badsanta_language');
            const savedTotalTroops = localStorage.getItem('totalTroops');
            const savedSquadComposition = localStorage.getItem('squadComposition');
            const savedSquadSizes = localStorage.getItem('squadSizes');
            const savedPresets = localStorage.getItem('squadPresets');
            
            if (savedLanguage) setLanguage(savedLanguage);
            if (savedTotalTroops) setTotalTroops(JSON.parse(savedTotalTroops));
            if (savedSquadComposition) setSquadComposition(JSON.parse(savedSquadComposition));
            if (savedSquadSizes) setSquadSizes(JSON.parse(savedSquadSizes));
            if (savedPresets) setSavedSquadPresets(JSON.parse(savedPresets));
          }, []);

          useEffect(() => {
            const unsubscribe = db.collection('players').onSnapshot(snapshot => {
              const playerData = [];
              snapshot.forEach(doc => {
                playerData.push({ id: doc.id, ...doc.data() });
              });
              setPlayers(playerData);
            });

            return () => unsubscribe();
          }, []);

          useEffect(() => { localStorage.setItem('totalTroops', JSON.stringify(totalTroops)); }, [totalTroops]);
          useEffect(() => { localStorage.setItem('squadComposition', JSON.stringify(squadComposition)); }, [squadComposition]);
          useEffect(() => { localStorage.setItem('squadSizes', JSON.stringify(squadSizes)); }, [squadSizes]);
          useEffect(() => { localStorage.setItem('squadPresets', JSON.stringify(savedSquadPresets)); }, [savedSquadPresets]);
          useEffect(() => { localStorage.setItem('badsanta_language', language); }, [language]);

          const toggleState = (state) => {
            setExpandedStates(prev => ({ ...prev, [state]: !prev[state] }));
          };

          const toggleAlliance = (stateAllianceKey) => {
            setExpandedAlliances(prev => ({ ...prev, [stateAllianceKey]: !prev[stateAllianceKey] }));
          };

          const addOrUpdatePlayer = async () => {
            if (!playerForm.name || !playerForm.playerId) {
              alert(t.playerName + ' and ' + t.playerId + ' required');
              return;
            }

            try {
              if (editingPlayer) {
                await db.collection('players').doc(editingPlayer.id).update(playerForm);
                setEditingPlayer(null);
              } else {
                await db.collection('players').add(playerForm);
              }
              setPlayerForm({ name: '', alliance: '', state: '', playerId: '', notes: '', tag: 'none', powerLevel: '' });
              setShowPlayerForm(false);
            } catch (error) {
              alert('Error: ' + error.message);
            }
          };

          const editPlayer = (player) => {
            setEditingPlayer(player);
            setPlayerForm({
              name: player.name, alliance: player.alliance || '', state: player.state || '',
              playerId: player.playerId, notes: player.notes || '', tag: player.tag || 'none', powerLevel: player.powerLevel || ''
            });
            setShowPlayerForm(true);
            setExpandedPlayer(null);
          };

          const deletePlayer = (id, event) => { event.stopPropagation(); setDeletingPlayerId(id); };
          
          const confirmDelete = async () => {
            try {
              await db.collection('players').doc(deletingPlayerId).delete();
              if (expandedPlayer === deletingPlayerId) setExpandedPlayer(null);
              setDeletingPlayerId(null);
            } catch (error) {
              alert('Error: ' + error.message);
            }
          };

          const cancelDelete = () => { setDeletingPlayerId(null); };
          const cancelPlayerForm = () => { setShowPlayerForm(false); setEditingPlayer(null); setPlayerForm({ name: '', alliance: '', state: '', playerId: '', notes: '', tag: 'none', powerLevel: '' }); };

          const exportPlayers = () => {
            if (players.length === 0) { alert('No players'); return; }
            const blob = new Blob([JSON.stringify(players, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `badsanta_players_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          };

          const searchById = () => setIdSearchResults(idSearchTerm.trim() ? players.filter(p => p.playerId === idSearchTerm.trim()) : []);
          const searchByAlliance = () => setAllianceSearchResults(allianceSearchTerm.trim() ? players.filter(p => p.alliance?.toLowerCase().includes(allianceSearchTerm.trim().toLowerCase())) : []);
          const searchByState = () => setStateSearchResults(stateSearchTerm.trim() ? players.filter(p => p.state?.toLowerCase().includes(stateSearchTerm.trim().toLowerCase())) : []); const calculateSquads = () => {
            setErrorMessage('');
            const [inf, lan, mar] = [parseFloat(totalTroops.infantry)||0, parseFloat(totalTroops.lancer)||0, parseFloat(totalTroops.marksmen)||0];
            if (!inf && !lan && !mar) { setErrorMessage(t.totalTroops + ' required'); return; }
            const sizes = squadSizes.map(s => parseFloat(s)).filter(s => !isNaN(s) && s > 0);
            if (!sizes.length) { setErrorMessage(t.squadSizes + ' required'); return; }
            const [iPct, lPct, mPct] = [parseFloat(squadComposition.infantry)||0, parseFloat(squadComposition.lancer)||0, parseFloat(squadComposition.marksmen)||0];
            if (Math.abs(iPct + lPct + mPct - 100) > 0.1) { setErrorMessage(`${t.total}: ${(iPct+lPct+mPct).toFixed(1)}% (need 100%)`); return; }
            const squads = []; let [tI, tL, tM] = [0,0,0];
            sizes.forEach((sz, idx) => {
              const [si, sl, sm] = [Math.floor(sz*iPct/100), Math.floor(sz*lPct/100), Math.floor(sz*mPct/100)];
              tI += si; tL += sl; tM += sm;
              squads.push({ id: idx+1, targetSize: sz, infantry: si, lancer: sl, marksmen: sm, total: si+sl+sm });
            });
            if (tI > inf || tL > lan || tM > mar) {
              setErrorMessage(`Not enough!\nâ€¢ ${t.infantry}: ${tI.toLocaleString()} (have ${inf.toLocaleString()})\nâ€¢ ${t.lancer}: ${tL.toLocaleString()} (have ${lan.toLocaleString()})\nâ€¢ ${t.marksmen}: ${tM.toLocaleString()} (have ${mar.toLocaleString()})`);
              return;
            }
            setCalculatedSquads(squads);
          };

          const addSquadSize = () => setSquadSizes([...squadSizes, '']);
          const removeSquadSize = (i) => setSquadSizes(squadSizes.filter((_, idx) => idx !== i));
          const updateSquadSize = (i, v) => { const n = [...squadSizes]; n[i] = v; setSquadSizes(n); };

          const suggestRatioToUseAll = (type) => {
            const [inf, lan, mar] = [parseFloat(totalTroops.infantry)||0, parseFloat(totalTroops.lancer)||0, parseFloat(totalTroops.marksmen)||0];
            const sizes = squadSizes.map(s => parseFloat(s)).filter(s => !isNaN(s) && s > 0);
            if (!sizes.length) { alert(t.squadSizes + ' first'); return; }
            const total = sizes.reduce((a,b) => a+b, 0);
            if (!total) { alert('Total = 0'); return; }
            const pct = (type === 'infantry' ? inf : type === 'lancer' ? lan : mar) / total * 100;
            if (pct > 100) { alert(`Not enough for all ${type}`); return; }
            const rem = 100 - pct;
            let [i, l, m] = [0,0,0];
            if (type === 'infantry') { i = pct; l = Math.min(lan/total*100, rem); m = 100-i-l; }
            else if (type === 'lancer') { l = pct; i = Math.min(inf/total*100, rem); m = 100-i-l; }
            else { m = pct; i = Math.min(inf/total*100, rem); l = 100-i-m; }
            [i,l,m] = [Math.round(i*10)/10, Math.round(l*10)/10, Math.round((100-Math.round(i*10)/10-Math.round(l*10)/10)*10)/10];
            setSquadComposition({ infantry: i.toString(), lancer: l.toString(), marksmen: m.toString() });
          };

          const calcManualRatios = () => {
            const [i, l, m] = [parseFloat(manualSquad.infantry)||0, parseFloat(manualSquad.lancer)||0, parseFloat(manualSquad.marksmen)||0];
            const t = i+l+m;
            return t ? { infantry: ((i/t)*100).toFixed(1), lancer: ((l/t)*100).toFixed(1), marksmen: ((m/t)*100).toFixed(1), total: t } : { infantry: 0, lancer: 0, marksmen: 0, total: 0 };
          };
          const applyManualRatios = () => {
            const r = calcManualRatios();
            if (r.total) { setSquadComposition({ infantry: r.infantry, lancer: r.lancer, marksmen: r.marksmen }); alert(t.applyRatios + '!'); }
          };

          const clearAllSquads = () => {
            setTotalTroops({ infantry: '', lancer: '', marksmen: '' });
            setSquadSizes(['']);
            setSquadComposition({ infantry: '10', lancer: '20', marksmen: '70' });
            setCalculatedSquads([]);
            setErrorMessage('');
            setManualSquad({ infantry: '', lancer: '', marksmen: '' });
            setShowClearConfirm(false);
          };

          const savePreset = () => {
            if (!presetName.trim()) { alert(t.presetName); return; }
            const p = { id: Date.now(), name: presetName, composition: {...squadComposition} };
            setSavedSquadPresets([...savedSquadPresets, p]);
            setPresetName('');
            alert(`"${p.name}" ${t.save}!`);
          };
          const loadPreset = (p) => { setSquadComposition(p.composition); alert(`Loaded "${p.name}"`); };
          const deletePreset = (id) => setSavedSquadPresets(savedSquadPresets.filter(p => p.id !== id));

          const getTagColor = (t) => t === 'suspicious' ? 'bg-red-600/30 border-red-500 text-red-400' : t === 'friendly' ? 'bg-green-600/30 border-green-500 text-green-400' : '';
          const getTagLabel = (tag) => tag === 'suspicious' ? `âš ï¸ ${t.suspicious}` : tag === 'friendly' ? `âœ“ ${t.friendly}` : '';
          const findDuplicateIds = (id) => players.filter(p => p.playerId === id);

          const filteredPlayers = players.filter(p =>
            p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (p.alliance && p.alliance.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (p.state && p.state.toLowerCase().includes(searchTerm.toLowerCase())) ||
            p.playerId.toLowerCase().includes(searchTerm.toLowerCase())
          );

          const playersByState = filteredPlayers.reduce((acc, p) => {
            const s = p.state || 'No State', a = p.alliance || 'No Alliance';
            if (!acc[s]) acc[s] = {};
            if (!acc[s][a]) acc[s][a] = [];
            acc[s][a].push(p);
            return acc;
          }, {});

          const sortedStates = Object.keys(playersByState).sort((a,b) => a === 'No State' ? 1 : b === 'No State' ? -1 : a.localeCompare(b));

          return (
            <div className="min-h-screen bg-gradient-to-br from-gray-100 via-white to-gray-100 text-gray-900" dir={isRTL ? 'rtl' : 'ltr'}>
              <div className="bg-gradient-to-r from-red-600 via-red-500 to-red-600 border-b border-red-400 p-4 shadow-lg">
                <div className="flex justify-between items-center">
                  <h1 className="text-3xl font-bold text-white drop-shadow-lg">ğŸ… {t.title} ğŸ„</h1>
                  <div className="flex gap-2">
                    <button onClick={() => setLanguage('en')} className={`px-2 py-1 rounded text-sm font-medium ${language === 'en' ? 'bg-white text-red-600' : 'bg-red-700 text-white'}`}>ğŸ‡¬ğŸ‡§ EN</button>
                    <button onClick={() => setLanguage('es')} className={`px-2 py-1 rounded text-sm font-medium ${language === 'es' ? 'bg-white text-red-600' : 'bg-red-700 text-white'}`}>ğŸ‡ªğŸ‡¸ ES</button>
                    <button onClick={() => setLanguage('ar')} className={`px-2 py-1 rounded text-sm font-medium ${language === 'ar' ? 'bg-white text-red-600' : 'bg-red-700 text-white'}`}>ğŸ‡¸ğŸ‡¦ AR</button>
                  </div>
                </div>
              </div>

              <div className="flex bg-white border-b border-gray-300 shadow-md">
                <button onClick={() => setActiveTab('players')} className={`flex-1 py-4 px-4 font-medium transition-all ${activeTab === 'players' ? 'bg-gradient-to-b from-blue-600 to-blue-700 text-white border-b-2 border-blue-400 shadow-lg' : 'text-gray-600 hover:bg-gray-100'}`}><Users className="inline mr-2" size={20} />{t.players}</button>
                <button onClick={() => setActiveTab('squads')} className={`flex-1 py-4 px-4 font-medium transition-all ${activeTab === 'squads' ? 'bg-gradient-to-b from-blue-600 to-blue-700 text-white border-b-2 border-blue-400 shadow-lg' : 'text-gray-600 hover:bg-gray-100'}`}><Shield className="inline mr-2" size={20} />{t.squads}</button>
              </div>

              <div className="p-4">
                {activeTab === 'players' ? (
                  <div>
                    {deletingPlayerId && (
                      <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg p-6 max-w-sm w-full border-2 border-red-600 shadow-2xl">
                          <h3 className="text-lg font-bold mb-3 text-red-400">âš ï¸ {t.confirmDelete}</h3>
                          <p className="text-gray-700 mb-4">{t.deleteQuestion}</p>
                          <div className="flex gap-3">
                            <button onClick={cancelDelete} className="flex-1 py-2 bg-gray-300 hover:bg-gray-400 rounded font-medium">{t.cancel}</button>
                            <button onClick={confirmDelete} className="flex-1 py-2 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 rounded font-medium text-white">{t.delete}</button>
                          </div>
                        </div>
                      </div>
                    )}

                    <div className="mb-4 p-3 bg-blue-50 border-blue-300 rounded-lg border">
                      <p className="text-sm text-blue-700">ğŸŒ <strong>{t.sharedDb}</strong></p>
                    </div>

                    <div className="mb-4 p-4 bg-white border-gray-300 rounded-lg border shadow-lg">
                      <h3 className="font-bold mb-3 flex items-center"><Search className="mr-2 text-blue-600" size={20} />{t.quickSearch}</h3>
                      <div className="mb-3"><label className="text-sm text-gray-600 mb-1 block">{t.byPlayerId}</label><div className="flex gap-2"><input type="text" placeholder={t.enterPlayerId} value={idSearchTerm} onChange={(e) => setIdSearchTerm(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && searchById()} className="flex-1 px-4 py-2 bg-white border-gray-300 text-gray-900 border rounded-lg" /><button onClick={searchById} className="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium text-white">{t.searchBtn}</button></div></div>
                      <div className="mb-3"><label className="text-sm text-gray-600 mb-1 block">{t.byAlliance}</label><div className="flex gap-2"><input type="text" placeholder={t.enterAlliance} value={allianceSearchTerm} onChange={(e) => setAllianceSearchTerm(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && searchByAlliance()} className="flex-1 px-4 py-2 bg-white border-gray-300 text-gray-900 border rounded-lg" /><button onClick={searchByAlliance} className="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium text-white">{t.searchBtn}</button></div></div>
                      <div><label className="text-sm text-gray-600 mb-1 block">{t.byState}</label><div className="flex gap-2"><input type="text" placeholder={t.enterState} value={stateSearchTerm} onChange={(e) => setStateSearchTerm(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && searchByState()} className="flex-1 px-4 py-2 bg-white border-gray-300 text-gray-900 border rounded-lg" /><button onClick={searchByState} className="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium text-white">{t.searchBtn}</button></div></div>
                      
                      {idSearchResults.length > 0 && (<div className="mt-3 p-3 bg-gradient-to-br from-green-900/40 to-green-800/30 border-2 border-green-600 rounded-lg shadow-lg"><p className="font-bold text-green-400 mb-2">âœ“ {t.found} {idSearchResults.length} {t.recordsForId} {idSearchTerm}</p>{idSearchResults.map((p, i) => (<div key={p.id} className="text-sm text-gray-300 mb-2"><p className="font-bold">{i + 1}. {p.name}</p>{p.alliance && <p className="ml-3">{t.alliance}: {p.alliance}</p>}{p.state && <p className="ml-3">{t.state}: {p.state}</p>}{p.notes && <p className="ml-3">{t.notes}: {p.notes}</p>}</div>))}{idSearchResults.length > 1 && <p className="text-yellow-400 text-sm mt-2">âš ï¸ {t.nameChanged} {idSearchResults.length} {t.times}</p>}</div>)}
                      {idSearchTerm && !idSearchResults.length && <div className="mt-3 p-3 bg-gray-200 border-gray-300 border rounded-lg"><p className="text-gray-600 text-sm">{t.noPlayerWithId} {idSearchTerm}</p></div>}
                      {allianceSearchResults.length > 0 && (<div className="mt-3 p-3 bg-gradient-to-br from-purple-900/40 to-purple-800/30 border-2 border-purple-600 rounded-lg shadow-lg"><p className="font-bold text-purple-400 mb-2">ğŸ‘¥ {t.found} {allianceSearchResults.length} {t.inAlliance} "{allianceSearchTerm}"</p>{allianceSearchResults.map((p, i) => (<div key={p.id} className="text-sm text-gray-300 mb-2 pb-2 border-b border-purple-800 last:border-0"><p className="font-bold">{i + 1}. {p.name}</p><p className="ml-3 text-xs">{t.id}: {p.playerId}</p>{p.state && <p className="ml-3 text-xs">{t.state}: {p.state}</p>}</div>))}</div>)}
                      {allianceSearchTerm && !allianceSearchResults.length && <div className="mt-3 p-3 bg-gray-200 border-gray-300 border rounded-lg"><p className="text-gray-600 text-sm">No players {t.inAlliance}: {allianceSearchTerm}</p></div>}
                      {stateSearchResults.length > 0 && (<div className="mt-3 p-3 bg-gradient-to-br from-orange-900/40 to-orange-800/30 border-2 border-orange-600 rounded-lg shadow-lg"><p className="font-bold text-orange-400 mb-2">ğŸ“ {t.found} {stateSearchResults.length} {t.inState} "{stateSearchTerm}"</p>{stateSearchResults.map((p, i) => (<div key={p.id} className="text-sm text-gray-300 mb-2 pb-2 border-b border-orange-800 last:border-0"><p className="font-bold">{i + 1}. {p.name}</p><p className="ml-3 text-xs">{t.id}: {p.playerId}</p>{p.alliance && <p className="ml-3 text-xs">{t.alliance}: {p.alliance}</p>}</div>))}</div>)}
                      {stateSearchTerm && !stateSearchResults.length && <div className="mt-3 p-3 bg-gray-200 border-gray-300 border rounded-lg"><p className="text-gray-600 text-sm">No players {t.inState}: {stateSearchTerm}</p></div>}
                    </div>

                    <div className="mb-4"><div className="relative"><Search className="absolute left-3 top-3 text-gray-500" size={20} /><input type="text" placeholder={t.searchPlayers} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-white border-gray-300 text-gray-900 border rounded-lg" /></div></div>

                    <div className="mb-4"><button onClick={exportPlayers} className="w-full py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 rounded-lg font-medium flex items-center justify-center shadow-lg text-white">ğŸ“¥ {t.exportBackup}</button></div>

                    {!showPlayerForm && <button onClick={() => setShowPlayerForm(true)} className="w-full mb-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 rounded-lg font-medium flex items-center justify-center shadow-lg text-white"><Plus size={20} className="mr-2" />{t.addPlayer}</button>}

                    {showPlayerForm && (<div className="mb-4 p-4 bg-white border-gray-300 rounded-lg border"><div className="flex justify-between items-center mb-3"><h3 className="font-bold">{editingPlayer ? t.editPlayer : t.addNewPlayer}</h3><button onClick={cancelPlayerForm}><X size={20} /></button></div><input type="text" placeholder={t.playerName + ' *'} value={playerForm.name} onChange={(e) => setPlayerForm({ ...playerForm, name: e.target.value })} className="w-full mb-2 p-2 bg-white border-gray-300 text-gray-900 border rounded" /><input type="text" placeholder={t.playerId + ' *'} value={playerForm.playerId} onChange={(e) => setPlayerForm({ ...playerForm, playerId: e.target.value })} className="w-full mb-2 p-2 bg-white border-gray-300 text-gray-900 border rounded" /><select value={playerForm.tag} onChange={(e) => setPlayerForm({ ...playerForm, tag: e.target.value })} className="w-full mb-2 p-2 bg-white border-gray-300 text-gray-900 border rounded"><option value="none">{t.noTag}</option><option value="suspicious">âš ï¸ {t.suspicious}</option><option value="friendly">âœ“ {t.friendly}</option></select><select value={playerForm.powerLevel} onChange={(e) => setPlayerForm({ ...playerForm, powerLevel: e.target.value })} className="w-full mb-2 p-2 bg-white border-gray-300 text-gray-900 border rounded"><option value="">{t.powerLevel}</option>{[...Array(30)].map((_, i) => <option key={i + 1} value={`${i + 1}`}>Level {i + 1}</option>)}{[...Array(10)].map((_, i) => <option key={`fc${i + 1}`} value={`FC${i + 1}`}>FC{i + 1}</option>)}</select><input type="text" placeholder={t.alliance} value={playerForm.alliance} onChange={(e) => setPlayerForm({ ...playerForm, alliance: e.target.value })} className="w-full mb-2 p-2 bg-white border-gray-300 text-gray-900 border rounded" /><input type="text" placeholder={t.state} value={playerForm.state} onChange={(e) => setPlayerForm({ ...playerForm, state: e.target.value })} className="w-full mb-2 p-2 bg-white border-gray-300 text-gray-900 border rounded" /><textarea placeholder={t.notes} value={playerForm.notes} onChange={(e) => setPlayerForm({ ...playerForm, notes: e.target.value })} className="w-full mb-3 p-2 bg-white border-gray-300 text-gray-900 border rounded h-20" /><button onClick={addOrUpdatePlayer} className="w-full py-2 bg-green-600 hover:bg-green-700 rounded font-medium text-white">{editingPlayer ? t.updatePlayer : t.savePlayer}</button></div>)}
                      <div className="space-y-4">{!filteredPlayers.length ? <div className="text-center text-gray-600 py-8">{t.noPlayersFound}</div> : sortedStates.map(state => {const alliances = Object.keys(playersByState[state]).sort((a,b) => a === 'No Alliance' ? 1 : b === 'No Alliance' ? -1 : a.localeCompare(b)); const total = Object.values(playersByState[state]).flat().length; const isStateExpanded = expandedStates[state]; return (<div key={state}><div onClick={() => toggleState(state)} className="cursor-pointer bg-gradient-to-r from-blue-500 via-blue-400 to-blue-500 border-blue-300 px-4 py-3 rounded-lg mb-2 border shadow-lg flex justify-between items-center"><h3 className="font-bold text-white flex items-center">ğŸ“ {state} ({total})</h3>{isStateExpanded ? <ChevronUp size={20} className="text-white" /> : <ChevronDown size={20} className="text-white" />}</div>{isStateExpanded && (<div className="space-y-3 ml-2">{alliances.map(alliance => {const stateAllianceKey = `${state}-${alliance}`; const isAllianceExpanded = expandedAlliances[stateAllianceKey]; return (<div key={stateAllianceKey}><div onClick={() => toggleAlliance(stateAllianceKey)} className="cursor-pointer bg-gradient-to-r from-purple-600 to-purple-500 border-purple-400 px-3 py-2 rounded mb-2 border shadow-md flex justify-between items-center"><h4 className="text-sm font-semibold text-white flex items-center">ğŸ‘¥ {alliance} ({playersByState[state][alliance].length})</h4>{isAllianceExpanded ? <ChevronUp size={16} className="text-white" /> : <ChevronDown size={16} className="text-white" />}</div>{isAllianceExpanded && (<div className="space-y-2 ml-2">{playersByState[state][alliance].map(player => {const dups = findDuplicateIds(player.playerId); const hasDups = dups.length > 1; const isExp = expandedPlayer === player.id; return (<div key={player.id} className={`rounded-lg border shadow-md ${hasDups ? 'bg-red-50 border-red-400' : 'bg-white border-gray-300 hover:border-gray-400'}`}><div onClick={() => setExpandedPlayer(isExp ? null : player.id)} className="p-3 cursor-pointer flex items-center justify-between"><div className="flex-1"><div className="flex items-center gap-2 flex-wrap">{hasDups && <AlertTriangle size={16} className="text-red-400" />}<span className="font-bold">{player.name}</span>{player.tag && player.tag !== 'none' && <span className={`text-xs px-2 py-0.5 rounded border ${getTagColor(player.tag)}`}>{getTagLabel(player.tag)}</span>}{player.powerLevel && <span className="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700">{player.powerLevel}</span>}</div><p className="text-xs text-gray-600">{t.id}: {player.playerId}</p></div>{isExp ? <ChevronUp size={20} /> : <ChevronDown size={20} />}</div>{isExp && (<div className="px-3 pb-3 border-t border-gray-300">{player.alliance && <p className="text-sm text-gray-700 mt-2"><span className="text-gray-600">{t.alliance}:</span> {player.alliance}</p>}{player.state && <p className="text-sm text-gray-700"><span className="text-gray-600">{t.state}:</span> {player.state}</p>}{player.notes && <p className="text-sm text-gray-700 mt-2"><span className="text-gray-600">{t.notes}:</span> {player.notes}</p>}{hasDups && <div className="mt-3 pt-3 border-t border-red-400"><p className="text-sm font-bold text-red-400 mb-2">{t.previousIdentities}</p>{dups.filter(d => d.id !== player.id).map(d => <div key={d.id} className="text-sm text-gray-700 ml-2 mb-1">â€¢ {d.name} {d.alliance && `[${d.alliance}]`} {d.state && `- ${d.state}`}</div>)}</div>}<div className="flex gap-2 mt-3"><button onClick={(e) => { e.stopPropagation(); editPlayer(player); }} className="flex-1 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium flex items-center justify-center text-white"><Edit2 size={16} className="mr-1" />{t.edit}</button><button onClick={(e) => deletePlayer(player.id, e)} className="flex-1 py-2 bg-red-600 hover:bg-red-700 rounded text-sm font-medium flex items-center justify-center text-white"><Trash2 size={16} className="mr-1" />{t.delete}</button></div></div>)}</div>);})}</div>)}</div>);})}</div>)}</div>);})}</div>
                  </div>
                ) : (
                  <div>
                    {showClearConfirm && (<div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-lg p-6 max-w-sm w-full border-2 border-red-600 shadow-2xl"><h3 className="text-lg font-bold mb-3 text-red-400">âš ï¸ {t.clearAll}?</h3><p className="text-gray-700 mb-4">{t.clearAllQuestion}</p><div className="flex gap-3"><button onClick={() => setShowClearConfirm(false)} className="flex-1 py-2 bg-gray-300 hover:bg-gray-400 rounded font-medium">{t.cancel}</button><button onClick={clearAllSquads} className="flex-1 py-2 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 rounded font-medium text-white">{t.clearAll}</button></div></div></div>)}
                    
                    <div className="mb-4"><button onClick={() => setShowClearConfirm(true)} className="w-full py-2 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 rounded-lg font-medium flex items-center justify-center shadow-lg text-white"><X size={20} className="mr-2" />{t.clearAll}</button></div>

                    <div className="mb-4 p-4 bg-white border-gray-300 rounded-lg border shadow-lg"><h3 className="font-bold mb-3 flex items-center"><Users className="mr-2 text-green-600" size={20} />{t.totalTroops}</h3><input type="number" placeholder={t.infantry} value={totalTroops.infantry} onChange={(e) => setTotalTroops({ ...totalTroops, infantry: e.target.value })} className="w-full mb-2 p-2 bg-white border-gray-300 text-gray-900 border rounded" /><input type="number" placeholder={t.lancer} value={totalTroops.lancer} onChange={(e) => setTotalTroops({ ...totalTroops, lancer: e.target.value })} className="w-full mb-2 p-2 bg-white border-gray-300 text-gray-900 border rounded" /><input type="number" placeholder={t.marksmen} value={totalTroops.marksmen} onChange={(e) => setTotalTroops({ ...totalTroops, marksmen: e.target.value })} className="w-full p-2 bg-white border-gray-300 text-gray-900 border rounded" /></div>

                    <div className="mb-4 p-4 bg-white border-gray-300 rounded-lg border shadow-lg"><div className="flex justify-between items-center mb-3"><h3 className="font-bold flex items-center"><Shield className="mr-2 text-blue-600" size={20} />{t.squadSizes}</h3><button onClick={addSquadSize} className="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium text-white"><Plus size={16} className="inline mr-1" />{t.addSquad}</button></div><p className="text-xs text-gray-600 mb-3">{t.enterTroopCount}</p><div className="space-y-2">{squadSizes.map((sz, i) => (<div key={i} className="flex items-center gap-2"><span className="text-sm text-gray-600 w-16">{t.squad} {i + 1}:</span><input type="number" placeholder={t.troopCount} value={sz} onChange={(e) => updateSquadSize(i, e.target.value)} className="flex-1 p-2 bg-white border-gray-300 text-gray-900 border rounded" />{squadSizes.length > 1 && <button onClick={() => removeSquadSize(i)} className="p-2 text-red-400 hover:text-red-300"><Trash2 size={18} /></button>}</div>))}</div></div>

                    <div className="mb-4 p-4 bg-white border-gray-300 rounded-lg border shadow-lg"><h3 className="font-bold mb-3">{t.squadComposition}</h3>{savedSquadPresets.length > 0 && (<div className="mb-3 p-3 bg-blue-50 border-blue-300 rounded-lg border"><p className="text-xs text-gray-600 mb-2">ğŸ’¾ {t.savedPresets}</p><div className="space-y-1">{savedSquadPresets.map(p => (<div key={p.id} className="flex items-center justify-between gap-2"><button onClick={() => loadPreset(p)} className="flex-1 text-left px-2 py-1 bg-blue-700 hover:bg-blue-600 rounded text-sm text-white">{p.name} ({p.composition.infantry}% / {p.composition.lancer}% / {p.composition.marksmen}%)</button><button onClick={() => deletePreset(p.id)} className="p-1 text-red-400 hover:text-red-300"><Trash2 size={16} /></button></div>))}</div></div>)}<div className="mb-3 p-3 bg-green-50 border-green-300 rounded-lg border"><p className="text-xs text-gray-600 mb-2">âš¡ {t.useAll}</p><div className="flex gap-2"><button onClick={() => suggestRatioToUseAll('infantry')} className="flex-1 py-2 bg-green-600 hover:bg-green-700 rounded text-xs font-medium text-white">{t.useAllInfantry}</button><button onClick={() => suggestRatioToUseAll('lancer')} className="flex-1 py-2 bg-green-600 hover:bg-green-700 rounded text-xs font-medium text-white">{t.useAllLancer}</button><button onClick={() => suggestRatioToUseAll('marksmen')} className="flex-1 py-2 bg-green-600 hover:bg-green-700 rounded text-xs font-medium text-white">{t.useAllMarksmen}</button></div></div><div className="space-y-2"><div className="flex items-center gap-2"><label className="w-24 text-sm text-gray-700">{t.infantry}:</label><input type="number" value={squadComposition.infantry} onChange={(e) => setSquadComposition({ ...squadComposition, infantry: e.target.value })} className="flex-1 p-2 bg-white border-gray-300 text-gray-900 border rounded" /><span className="text-gray-600">%</span></div><div className="flex items-center gap-2"><label className="w-24 text-sm text-gray-700">{t.lancer}:</label><input type="number" value={squadComposition.lancer} onChange={(e) => setSquadComposition({ ...squadComposition, lancer: e.target.value })} className="flex-1 p-2 bg-white border-gray-300 text-gray-900 border rounded" /><span className="text-gray-600">%</span></div><div className="flex items-center gap-2"><label className="w-24 text-sm text-gray-700">{t.marksmen}:</label><input type="number" value={squadComposition.marksmen} onChange={(e) => setSquadComposition({ ...squadComposition, marksmen: e.target.value })} className="flex-1 p-2 bg-white border-gray-300 text-gray-900 border rounded" /><span className="text-gray-600">%</span></div></div><div className="mt-3 text-sm text-gray-600">{t.total}: {(parseFloat(squadComposition.infantry) || 0) + (parseFloat(squadComposition.lancer) || 0) + (parseFloat(squadComposition.marksmen) || 0)}%</div><div className="mt-3 pt-3 border-t border-gray-300"><p className="text-xs text-gray-600 mb-2">ğŸ’¾ {t.saveComposition}</p><div className="flex gap-2"><input type="text" placeholder={t.presetName} value={presetName} onChange={(e) => setPresetName(e.target.value)} className="flex-1 p-2 bg-white border-gray-300 text-gray-900 border rounded text-sm" /><button onClick={savePreset} className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-medium text-sm text-white">{t.save}</button></div></div></div>

                    <div className="mb-4"><button onClick={() => setManualSquadMode(!manualSquadMode)} className="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 rounded-lg font-medium flex items-center justify-center shadow-lg text-white">{manualSquadMode ? `ğŸ‘ï¸ ${t.hide}` : 'ğŸ”§'} {t.manualBuilder}</button></div>
                    {manualSquadMode && (<div className="mb-4 p-4 bg-purple-50 border-purple-400 rounded-lg border-2 shadow-xl"><h3 className="font-bold mb-3 text-purple-600 flex items-center">ğŸ”§ {t.manualBuilder}</h3><p className="text-xs text-purple-700 mb-3">{t.experimentTroops}</p><div className="space-y-2 mb-3"><input type="number" placeholder={t.infantryAmount} value={manualSquad.infantry} onChange={(e) => setManualSquad({ ...manualSquad, infantry: e.target.value })} className="w-full p-2 bg-white border-purple-300 text-gray-900 border rounded" /><input type="number" placeholder={t.lancerAmount} value={manualSquad.lancer} onChange={(e) => setManualSquad({ ...manualSquad, lancer: e.target.value })} className="w-full p-2 bg-white border-purple-300 text-gray-900 border rounded" /><input type="number" placeholder={t.marksmenAmount} value={manualSquad.marksmen} onChange={(e) => setManualSquad({ ...manualSquad, marksmen: e.target.value })} className="w-full p-2 bg-white border-purple-300 text-gray-900 border rounded" /></div>{(() => {const r = calcManualRatios(); return r.total > 0 ? (<div className="p-3 bg-white rounded-lg mb-3"><p className="text-sm font-bold mb-2">{t.resultingRatios}</p><div className="space-y-1 text-sm"><div className="flex justify-between"><span>{t.infantry}:</span><span className="font-bold text-blue-600">{r.infantry}%</span></div><div className="flex justify-between"><span>{t.lancer}:</span><span className="font-bold text-blue-600">{r.lancer}%</span></div><div className="flex justify-between"><span>{t.marksmen}:</span><span className="font-bold text-blue-600">{r.marksmen}%</span></div><div className="flex justify-between border-t border-gray-300 pt-1 mt-1"><span>{t.total}:</span><span className="font-bold">{r.total.toLocaleString()}</span></div></div></div>) : null;})()}<button onClick={applyManualRatios} className="w-full py-2 bg-purple-600 hover:bg-purple-700 rounded font-medium text-white">{t.applyRatios}</button></div>)}

                    {errorMessage && (<div className="mb-4 p-4 bg-gradient-to-br from-red-100 to-red-50 border-2 border-red-600 rounded-lg shadow-lg"><p className="text-red-600 font-bold mb-2">âš ï¸ {t.error}</p><p className="text-sm text-red-700 whitespace-pre-line">{errorMessage}</p></div>)}
                    <button onClick={calculateSquads} className="w-full mb-4 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 rounded-lg font-bold text-lg shadow-xl text-white">âš”ï¸ {t.calculateSquads}</button>

                    {calculatedSquads.length > 0 && (<div><div className="flex justify-between items-center mb-3"><h3 className="font-bold text-lg">{t.calculatedSquads}</h3><button onClick={() => setCalculatedSquads([])} className="text-sm text-red-600 hover:text-red-700">{t.clear}</button></div><div className="mb-4 p-4 bg-gradient-to-br from-blue-100 to-blue-50 border-2 border-blue-600 rounded-lg shadow-lg"><p className="text-sm font-bold mb-2 text-blue-700">ğŸ“Š {t.totalUsage}</p><p className="text-xs text-gray-700">{t.infantry}: {calculatedSquads.reduce((s, sq) => s + sq.infantry, 0).toLocaleString()} / {totalTroops.infantry}</p><p className="text-xs text-gray-700">{t.lancer}: {calculatedSquads.reduce((s, sq) => s + sq.lancer, 0).toLocaleString()} / {totalTroops.lancer}</p><p className="text-xs text-gray-700">{t.marksmen}: {calculatedSquads.reduce((s, sq) => s + sq.marksmen, 0).toLocaleString()} / {totalTroops.marksmen}</p></div><div className="space-y-2">{calculatedSquads.map(sq => (<div key={sq.id} className="p-4 bg-white border-gray-300 rounded-lg border shadow-md"><h4 className="font-bold mb-2 text-blue-600">âš”ï¸ {t.squad} {sq.id}</h4><div className="space-y-1 text-sm"><div className="flex justify-between"><span className="text-gray-600">{t.infantry}:</span><span>{sq.infantry.toLocaleString()} ({squadComposition.infantry}%)</span></div><div className="flex justify-between"><span className="text-gray-600">{t.lancer}:</span><span>{sq.lancer.toLocaleString()} ({squadComposition.lancer}%)</span></div><div className="flex justify-between"><span className="text-gray-600">{t.marksmen}:</span><span>{sq.marksmen.toLocaleString()} ({squadComposition.marksmen}%)</span></div><div className="flex justify-between border-t border-gray-300 pt-1 mt-1 font-bold"><span>{t.total}:</span><span>{sq.total.toLocaleString()}</span></div></div></div>))}</div></div>)}
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<GameTracker />, document.getElementById('root'));
    </script>
</body>
</html>
